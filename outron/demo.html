<!DOCTYPE html>
<html>
  <head>
    <title>OUTRON - DEMO</title>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/gl-matrix/2.8.1/gl-matrix-min.js"
      integrity="sha512-zhHQR0/H5SEBL3Wn6yYSaTTZej12z0hVZKOv3TwCUXT1z5qeqGcXJLLrbERYRScEDDpYIJhPC1fk31gqR783iQ=="
      crossorigin="anonymous"
    ></script>
    <script src="./src/timeline.js"></script>
    <script src="./src/events.js"></script>
    <script src="./src/palette.js"></script>
    <script src="./src/webgl.js"></script>
    <script src="./src/geometry.js"></script>
    <script src="./src/demo.js"></script>
    <script id="vertex-shader-2d" type="x-shader/x-vertex">

      attribute vec4 aVertexPosition;
      attribute vec2 aTextureCoord;

      varying highp vec2 vTextureCoord;
      varying highp float vZ;

      uniform mat4 uModelViewMatrix;
      uniform mat4 uProjectionMatrix;
      uniform float uTime;
      uniform float uStretch;

      void main() {
        vec4 position = vec4(aVertexPosition.xyz,1.0);
        position.x += normalize(position.x) * uStretch;
        gl_Position = uProjectionMatrix * uModelViewMatrix * position;
        vTextureCoord = aTextureCoord;
        vZ = aVertexPosition.z;
      }
    </script>

    <script id="fragment-shader-2d" type="x-shader/x-fragment">
      precision mediump float;

      varying highp vec2 vTextureCoord;
      varying highp float vZ;

      uniform sampler2D uSampler;
      uniform float uTime;
      uniform float uFogDepth;
      uniform vec4 uFogColor;

      void main() {
        float fog = min(1.0,max(0.0,(vZ+uFogDepth)/15.0));
        gl_FragColor = (texture2D(uSampler, vTextureCoord)+0.1) * fog + uFogColor * (1.0 - fog);
        //gl_FragColor = texture2D(uSampler, vTextureCoord);
      }
    </script>
    <script></script>
    <link rel="stylesheet" href="demo.css" />
  </head>
  <body>
    <canvas id="webgl-canvas" width="480" height="480"></canvas>
    <!--<section id="title">RADIATION</section>-->
    <div class="slide">
      <section id="outron" class="hidden">
        <image class="logo-animations" src="./img/outron.svg" />
      </section>
    </div>
    <div class="slide">
      <section id="title" class="hidden">
        <image class="logo-animations" src="./img/title_3.svg" />
      </section>
    </div>
    <section id="vignette"></section>
    <section id="info" onclick="play()">CLICK TO START</section>

    <section id="debug">
      <div>now: <span id="debug-time"></span></div>
      <div>fps: <span id="debug-fps"></span></div>
      <div>delta: <span id="debug-delta"></span></div>
      <div><span id="debug-output"></span></div>
      <div id="debug-canvas"></div>
      <div id="debug-light-color-buttons"></div>
    </section>

    <section id="debug-events">
      <table>
        <tbody id="debug-events-table-body"></tbody>
      </table>
    </section>

    <audio id="music" controls src="./audio/OUTRON_42_00.mp3"></audio>
  </body>
  <script>
    let demoPlaying = false;

    function play() {
      const url = new URL(document.location);
      const musicEnabled = url.searchParams.get("music")
        ? url.searchParams.get("music") === "true"
        : true;
      const clearEffects = url.searchParams.get("clear-effects") === "true";
      const showDebug = url.searchParams.get("debug") === "true";
      const showAudio = url.searchParams.get("show-audio") === "true";

      if (showDebug === true) {
        document.getElementById("debug").style.display = "block";
        document.getElementById("debug-events").style.display = "block";
        renderLightPaletteButtons();
      }

      const audio = document.getElementById("music");

      if (showAudio === true) {
        audio.style.display = "inline-block";
      }

      if (!demoPlaying) {
        if (musicEnabled === true) {
          audio
            .play()
            .then(() => {
              demoPlaying = true;
              document.getElementById("info").style.display = "none";
              //document.getElementById("outron").style.opacity = 0.0;
              main({ musicEnabled, clearEffects, showDebug });
            })
            .catch((error) => {
              console.error(error);
            });
        } else {
          demoPlaying = true;
          document.getElementById("info").style.display = "none";
          //document.getElementById("outron").style.opacity = 0.0;
          main({ musicEnabled, clearEffects, showDebug });
        }
      }
    }

    function renderLightPaletteButtons() {
      const lightPaletteButtonsElement = document.getElementById(
        "debug-light-color-buttons"
      );
      for (let i = 0; i < lightPalette.length; i++) {
        const buttonElement = document.createElement("button");
        buttonElement.type = "button";
        buttonElement.style.backgroundColor = `rgb(${
          lightPalette[i][0] * 255
        },${lightPalette[i][1] * 255},${lightPalette[i][2] * 255})`;

        buttonElement.onclick = (event) => {
          console.log(lightPalette[i]);
          eventToBeAdded = {
            id: `light-color-${
              timeline.getEventsByType(EVENT_TYPES.LIGHT_COLOR).length + 1
            }`,
            type: EVENT_TYPES.LIGHT_COLOR,
            params: { index: i },
          };
        };
        lightPaletteButtonsElement.appendChild(buttonElement);
      }
    }

    function renderEvents(timeline) {
      const elementsTableBodyElement = document.getElementById(
        "debug-events-table-body"
      );
      elementsTableBodyElement.innerHTML = "";
      timeline.events.forEach((event, index) => {
        const eventRowElement = document.createElement("tr");
        eventRowElement.id = event.id + "row";

        const eventStartCellElement = document.createElement("td");
        eventStartCellElement.textContent = Math.floor(event.start);
        eventStartCellElement.style.cursor = "pointer";
        eventStartCellElement.style.textDecoration = "underline";
        eventStartCellElement.onclick = (e) => {
          document.getElementById("music").currentTime = event.start / 1000;
        };
        eventRowElement.appendChild(eventStartCellElement);

        const eventIdCellElement = document.createElement("td");
        eventIdCellElement.textContent = event.id;
        eventRowElement.appendChild(eventIdCellElement);

        const eventTypeCellElement = document.createElement("td");
        eventTypeCellElement.textContent = EVENT_TYPES.toString(event.type);
        eventRowElement.appendChild(eventTypeCellElement);

        const eventParamsCellElement = document.createElement("td");
        eventParamsCellElement.style.width = "5px";
        switch (event.type) {
          case EVENT_TYPES.LIGHT_COLOR: {
            const color = lightPalette[event.params.index];
            eventParamsCellElement.style.backgroundColor = `rgb(${
              color[0] * 255
            },${color[1] * 255},${color[2] * 255})`;
          }
        }
        eventRowElement.appendChild(eventParamsCellElement);

        const eventRemoveCellElement = document.createElement("td");
        eventRemoveCellElement.className = "remove-event";
        eventRemoveCellElement.textContent = "x";
        eventRemoveCellElement.onclick = (e) => {
          timeline.removeEventById(event.id);
          document.getElementById(event.id + "row").remove();
        };
        eventRowElement.appendChild(eventRemoveCellElement);

        elementsTableBodyElement.appendChild(eventRowElement);
      });
    }

    let previousCurrentEventElements = [];

    function updateEvents(timeline, now) {
      previousCurrentEventElements.forEach((element) => {
        element.className = "";
      });

      previousCurrentElements = [];

      const currentEvents = timeline.getCurrentEvents(now);

      currentEvents.forEach((event) => {
        const currentEventElement = document.getElementById(event.id + "row");
        currentEventElement.className = "current";
        previousCurrentEventElements.push(currentEventElement);
      });
    }
  </script>
</html>
