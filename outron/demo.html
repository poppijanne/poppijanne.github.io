<!DOCTYPE html>
<html>
  <head>
    <title>OUTRON - DEMO</title>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/gl-matrix/2.8.1/gl-matrix-min.js"
      integrity="sha512-zhHQR0/H5SEBL3Wn6yYSaTTZej12z0hVZKOv3TwCUXT1z5qeqGcXJLLrbERYRScEDDpYIJhPC1fk31gqR783iQ=="
      crossorigin="anonymous"
    ></script>
    <script src="./timeline.js"></script>
    <script src="./events.js"></script>
    <script src="./palette.js"></script>
    <script src="./webgl.js"></script>

    <script src="./demo.js"></script>
    <script id="vertex-shader-2d" type="x-shader/x-vertex">

      attribute vec4 aVertexPosition;
      attribute vec2 aTextureCoord;

      varying highp vec2 vTextureCoord;
      varying highp float vZ;

      uniform mat4 uModelViewMatrix;
      uniform mat4 uProjectionMatrix;
      uniform float uTime;
      uniform float uStretch;

      void main() {
        vec4 position = vec4(aVertexPosition.xyz,1.0);
        position.x += normalize(position.x) * uStretch;
        gl_Position = uProjectionMatrix * uModelViewMatrix * position;
        vTextureCoord = aTextureCoord;
        vZ = aVertexPosition.z;
      }
    </script>

    <script id="fragment-shader-2d" type="x-shader/x-fragment">
      precision mediump float;

      varying highp vec2 vTextureCoord;
      varying highp float vZ;

      uniform sampler2D uSampler;
      uniform sampler2D uSampler2;
      uniform float uTime;
      uniform float uFogDepth;

      mediump float easeInOutExpo(mediump float x) {
        return x == 0.0
          ? 0.0
          : x == 1.0
          ? 1.0
          : x < 0.5 ? pow(2.0, 20.0 * x - 10.0) / 2.0
          : (2.0 - pow(2.0, -20.0 * x + 10.0)) / 2.0;
      }

      mediump float easeOutCubic(mediump float x) {
        return 1.0 - pow(1.0 - x, 3.0);
      }

      float colorCorrectionFactor(vec3 color) {
        return easeOutCubic((color.r + color.g + color.b) / 3.0);
      }

      void main() {
        gl_FragColor = texture2D(uSampler, vTextureCoord);
        gl_FragColor.a *= texture2D(uSampler2, vTextureCoord).a;

        //gl_FragColor.a *= 1.0-min(1.0,max(0.0,(vZ-12.0)));

        gl_FragColor.a *= min(1.0,max(0.0,(vZ+uFogDepth)*0.09));
        //gl_FragColor.rgb *= min(1.0,2.5-easeOutCubic((vZ+12.00)/6.00));

        //gl_FragColor.a = min(1.0,max(0.0,1.5+vZ*0.120));
        //gl_FragColor.a *= min(1.0,max(0.0,(abs(vZ*vZ)-12.0)*0.001));
        //gl_FragColor.a *= easeOutCubic(gl_FragColor.a);
        //gl_FragColor.rgb *= colorCorrectionFactor(gl_FragColor.rgb);
      }
    </script>
    <link rel="stylesheet" href="demo.css" />
  </head>
  <body>
    <canvas id="webgl-canvas" width="480" height="480"></canvas>
    <!--<section id="title">RADIATION</section>-->
    <section id="outron">
      <image src="outron.svg" />
    </section>
    <section id="title">
      <image src="title.svg" />
    </section>
    <section id="vignette"></section>
    <section id="info" onclick="play()">CLICK TO START</section>

    <section id="debug">
      <div>now: <span id="debug-time"></span></div>
      <div>events: <span id="debug-event"></span></div>
      <div>fps: <span id="debug-fps"></span></div>
      <div>delta: <span id="debug-delta"></span></div>
      <div><span id="debug-output"></span></div>
      <div id="debug-canvas"></div>
    </section>

    <audio id="music" controls src="OUTRON_42_00.mp3"></audio>
  </body>
  <script>
    let demoPlaying = false;

    function play() {
      const url = new URL(document.location);
      const musicEnabled = url.searchParams.get("music")
        ? url.searchParams.get("music") === "true"
        : true;
      const clearEffects = url.searchParams.get("clear-effects") === "true";
      const showDebug = url.searchParams.get("debug") === "true";
      const showAudio = url.searchParams.get("show-audio") === "true";

      if (showDebug === true) {
        document.getElementById("debug").style.display = "block";
      }

      const audio = document.getElementById("music");

      if (showAudio === true) {
        audio.style.display = "inline-block";
      }

      if (!demoPlaying) {
        if (musicEnabled === true) {
          audio
            .play()
            .then(() => {
              demoPlaying = true;
              document.getElementById("info").style.display = "none";
              document.getElementById("outron").style.opacity = 1.0;
              main({ musicEnabled, clearEffects, showDebug });
            })
            .catch((error) => {
              console.error(error);
            });
        } else {
          demoPlaying = true;
          document.getElementById("info").style.display = "none";
          document.getElementById("outron").style.opacity = 1.0;
          main({ musicEnabled, clearEffects, showDebug });
        }
      }
    }
  </script>
</html>
